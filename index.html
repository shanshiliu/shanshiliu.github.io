<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>çº¢åŒ…æŠ½å¥–åº”ç”¨ (UIè¿˜åŸ+æ–°çº¢åŒ…æ ·å¼)</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script> 
  
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    /* æ»šåŠ¨æ¡æ ·å¼ */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }

    /* ---------------- åŠ¨ç”»å®šä¹‰ ---------------- */
    
    /* 1. é»˜è®¤æ¼‚æµ® (Waterfall) - ä¿®å¤ä½ç½®çªå˜é—®é¢˜ï¼Œè®©ç§»åŠ¨æ›´å¹³æ»‘ */
    @keyframes waterfall {
        0% { transform: translateY(0) rotate(0deg); }
        50% { transform: translateY(8px) rotate(1deg); }
        100% { transform: translateY(0) rotate(0deg); }
    }
    .animate-waterfall {
        animation: waterfall 4s ease-in-out infinite;
    }

    /* 2. æŠ½å¥–æ´—ç‰Œ (Shuffle) */
    .perspective-wrapper { perspective: 800px; transform-style: preserve-3d; }
    
    @keyframes shuffle {
        0% { transform: translate3d(0, 0, 0) rotate(0deg); }
        25% { transform: translate3d(20px, -20px, 40px) rotate(15deg); } 
        50% { transform: translate3d(-15px, 20px, -20px) rotate(-10deg); }
        75% { transform: translate3d(15px, -10px, 20px) rotate(5deg); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg); }
    }
    .animate-shuffle { animation: shuffle 0.8s linear infinite; }

    /* 3. ä¸­å¥–è„‰å†² */
    @keyframes pulse-gold {
        0%, 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); transform: scale(1); }
        50% { box-shadow: 0 0 20px 10px rgba(255, 215, 0, 0); transform: scale(1.05); }
    }
    .animate-pulse-fast { animation: pulse-gold 1s infinite; }

    .red-packet-inner {
        transform-style: preserve-3d;
        transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* ---------------- çº¢åŒ… UI æ ¸å¿ƒæ ·å¼ (ä¿ç•™æ–°ç‰ˆ) ---------------- */

    .red-packet-base {
        width: 90px;
        height: 115px;
        border-radius: 8px;
        /* æ·±çº¢æ¸å˜ */
        background: linear-gradient(160deg, #d32f2f 0%, #b71c1c 100%);
        /* å¤–éƒ¨é˜´å½± */
        box-shadow: 0 4px 8px rgba(0,0,0,0.3), inset 0 0 0 1px rgba(255,255,255,0.1);
        position: relative;
        overflow: hidden; 
        display: flex;
        flex-direction: column;
    }

    /* åœ†æ¶¦ç«‹ä½“å°å£ */
    .red-packet-seal {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 45px; 
        z-index: 20;
        border-radius: 0 0 50% 50%;
        background: linear-gradient(180deg, #e53935 0%, #c62828 100%);
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.4);
        border-top: 1px solid rgba(255,255,255,0.1);
        display: flex;
        justify-content: center;
        align-items: flex-end;
    }

    .red-packet-seal::before {
        content: '';
        position: absolute;
        bottom: 6px;
        width: 70%;
        height: 1px;
        background: rgba(255, 215, 0, 0.3);
    }

    /* é‡‘å¸å›¾æ ‡ (å°å£å¤„) */
    .prize-coin {
        width: 24px;
        height: 24px;
        background: linear-gradient(135deg, #ffd700 0%, #fdb931 50%, #d4af37 100%);
        border-radius: 50%;
        border: 2px solid #fff5c3; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: serif;
        font-weight: bold;
        font-size: 14px;
        color: #b71c1c;
        transform: translateY(50%); 
        margin-bottom: 2px; 
        z-index: 25;
    }

    /* ä¸»ä½“çº¹ç† */
    .red-packet-body-deco {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 60%;
        height: 40px;
        opacity: 0.1;
        background-image: radial-gradient(circle, #ffd700 1px, transparent 1px);
        background-size: 8px 8px;
    }

    /* é€‰ä¸­/ä¸­å¥–çŠ¶æ€ */
    .red-packet-base.is-selected {
        background: linear-gradient(135deg, #ffd700 0%, #ffca28 100%) !important;
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
        border: 2px solid #fff;
    }
    .red-packet-base.is-selected .red-packet-seal {
        background: linear-gradient(180deg, #ffca28 0%, #ffb300 100%) !important;
    }
    .red-packet-base.is-selected .prize-coin {
        background: #d32f2f;
        color: #ffd700;
        border-color: #ffcdd2;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo } = React;

    // --- SVG å›¾æ ‡å®šä¹‰ ---
    const Icon = ({ children, size = 24, className = '', ...props }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
    );
    const Settings = (props) => <Icon {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.78 1.46a2 2 0 0 0 .73 2.73l.15.08a2 2 0 0 1 1 1.73v.22a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 0-1 1.73v.18a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.78-1.46a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.73v-.22a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 0 1-1.73v-.18a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>;
    const RotateCcw = (props) => <Icon {...props}><path d="M3 12a9 9 0 1 0 9-9 7.37 7.37 0 0 0-2.9 2.5L2 9"/><path d="M3 2v7h7"/></Icon>;
    const Gift = (props) => <Icon {...props}><polyline points="20 12 12 12 12 21"/><path d="M19 12h2a2 2 0 0 0-2-2H8.38"/><path d="M10.13 5.378A2 2 0 0 0 8.38 5H3v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9.378A2 2 0 0 0 19 8h-6"/><line x1="12" x2="12" y1="12" y2="2"/></Icon>;
    const Play = (props) => <Icon {...props}><polygon points="5 3 19 12 5 21 5 3"/></Icon>;
    const X = (props) => <Icon {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>;

    // --- Mock Storage ---
    const mockStorage = (function() {
      let store = {};
      const STORAGE_KEY = 'mock_lottery_store'; 
      try { store = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch (e) {}
      const save = () => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(store)); } catch (e) {} };
      return {
        get: async (key) => ({ value: store[key] }),
        set: async (key, value) => { store[key] = value; save(); },
        delete: async (key) => { delete store[key]; save(); },
        clearAll: async () => { store = {}; try { localStorage.removeItem(STORAGE_KEY); } catch (e) {} }
      };
    })();
    window.storage = mockStorage;

    // --- Main App ---
    const LuckyDrawApp = () => {
        const [currentPage, setCurrentPage] = useState('loading');
        const [config, setConfig] = useState(null);
        const [redPackets, setRedPackets] = useState([]);
        const [openedPackets, setOpenedPackets] = useState(new Set());
        const [currentRound, setCurrentRound] = useState(1);
        const [showResult, setShowResult] = useState(null);
        const [animating, setAnimating] = useState(false);
        const [showResetModal, setShowResetModal] = useState(false);
        const [showReconfigModal, setShowReconfigModal] = useState(false);
        const [showNextRoundConfirm, setShowNextRoundConfirm] = useState(false);
        const [selectedPacketId, setSelectedPacketId] = useState(null);
        const [wonPrizes, setWonPrizes] = useState([]);

        const allOpened = openedPackets.size === config?.totalPackets;
        const unopenedPacketsCount = config ? config.totalPackets - openedPackets.size : 0;
        const isLastRound = config && currentRound === config.totalRounds;
        const openedCount = openedPackets.size;

        const generateFinalPosition = () => ({
            finalX: Math.floor(Math.random() * 60) - 30,
            finalY: Math.floor(Math.random() * 60) - 30,
            finalRotation: Math.floor(Math.random() * 60) - 30,
        });

        // åŠ è½½é…ç½®
        useEffect(() => {
            const loadConfig = async () => {
                try {
                    const result = await window.storage.get('lottery_config');
                    if (result && result.value) {
                        const savedConfig = JSON.parse(result.value);
                        setConfig(savedConfig);
                        const round = await window.storage.get('current_round');
                        const opened = await window.storage.get('opened_packets');
                        const won = await window.storage.get('won_prizes');
                        if (round?.value) setCurrentRound(parseInt(round.value));
                        if (opened?.value) setOpenedPackets(new Set(JSON.parse(opened.value)));
                        if (won?.value) setWonPrizes(JSON.parse(won.value));
                        setCurrentPage('draw');
                    } else {
                        setCurrentPage('setup');
                    }
                } catch { setCurrentPage('setup'); }
            };
            loadConfig();
        }, []);

        // ç”Ÿæˆçº¢åŒ…
        const generateRedPackets = useCallback(() => {
            if (!config) return;
            const prizePool = [];
            config.prizes.forEach(p => { for(let i=0; i<p.count; i++) prizePool.push({name: p.name, color: p.color}); });
            for(let i=0; i<config.totalPackets - prizePool.length; i++) prizePool.push(null);
            
            for(let i=prizePool.length-1; i>0; i--) {
                const j = Math.floor(Math.random() * (i+1));
                [prizePool[i], prizePool[j]] = [prizePool[j], prizePool[i]];
            }
            setRedPackets(prizePool.map((p, i) => ({ id: i, prize: p, ...generateFinalPosition() })));
        }, [config]);

        useEffect(() => { if (config && currentPage === 'draw') generateRedPackets(); }, [config, currentRound, currentPage]);

        // åŠ¨ç”»æœŸé—´éšæœºäº¤æ¢ä½ç½®
        useEffect(() => {
            let intervalId;
            if (animating) {
                intervalId = setInterval(() => {
                    setRedPackets(prev => {
                        const visible = prev.filter(p => !openedPackets.has(p.id));
                        const opened = prev.filter(p => openedPackets.has(p.id));
                        if (visible.length <= 1) return prev;
                        const shuffled = [...visible];
                        for(let i=shuffled.length-1; i>0; i--) {
                            const j = Math.floor(Math.random() * (i+1));
                            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                        }
                        return [...shuffled, ...opened];
                    });
                }, 200);
            }
            return () => clearInterval(intervalId);
        }, [animating, openedPackets]);

        // --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---

        const handleSetupSubmit = async (data) => {
            await window.storage.set('lottery_config', JSON.stringify(data));
            await window.storage.set('current_round', '1');
            await window.storage.set('opened_packets', JSON.stringify([]));
            await window.storage.set('won_prizes', JSON.stringify([]));
            setConfig(data); setCurrentRound(1); setOpenedPackets(new Set()); setWonPrizes([]); setCurrentPage('draw'); setShowReconfigModal(false);
        };

        const handlePacketOpen = async (packet) => {
            const newOpened = new Set(openedPackets); newOpened.add(packet.id); setOpenedPackets(newOpened);
            const prize = packet.prize || false;
            if (prize) setWonPrizes(prev => [...prev, prize]);
            await window.storage.set('opened_packets', JSON.stringify([...newOpened]));
            if (prize) {
                const w = await window.storage.get('won_prizes');
                const cw = w?.value ? JSON.parse(w.value) : [];
                await window.storage.set('won_prizes', JSON.stringify([...cw, prize]));
            }
            setShowResult(prize); setAnimating(false);
        };

        const startDraw = () => {
            if (animating || unopenedPacketsCount === 0) return;
            setShowResult(null); setSelectedPacketId(null); setAnimating(true);
            const unopened = redPackets.filter(p => !openedPackets.has(p.id));
            if (unopened.length === 0) { setAnimating(false); return; }
            
            const winner = unopened[Math.floor(Math.random() * unopened.length)];
            const startTime = Date.now();
            const duration = 2500;
            
            const step = () => {
                if (Date.now() - startTime < duration) {
                    const random = unopened[Math.floor(Math.random() * unopened.length)];
                    setSelectedPacketId(random.id);
                    const elapsed = Date.now() - startTime;
                    const remaining = duration - elapsed;
                    setTimeout(step, 80 + (200 * (1 - remaining/duration)));
                } else {
                    setSelectedPacketId(winner.id);
                    setTimeout(() => handlePacketOpen(winner), 1200);
                }
            };
            step();
        };

        const handleNextRound = async () => {
            if (currentRound >= config.totalRounds) return;
            const next = currentRound + 1;
            setCurrentRound(next); setOpenedPackets(new Set()); setWonPrizes([]); setShowResult(null); setShowNextRoundConfirm(false);
            await window.storage.set('current_round', next.toString());
            await window.storage.set('opened_packets', JSON.stringify([]));
            await window.storage.set('won_prizes', JSON.stringify([]));
        };

        const confirmNextRound = () => {
            if (unopenedPacketsCount > 0) setShowNextRoundConfirm(true);
            else handleNextRound();
        };

        const confirmReset = async () => {
            await window.storage.set('opened_packets', JSON.stringify([]));
            await window.storage.set('won_prizes', JSON.stringify([]));
            setOpenedPackets(new Set()); setWonPrizes([]); setShowResult(null); setSelectedPacketId(null); setShowResetModal(false); generateRedPackets();
        };

        const confirmReconfig = async () => {
            await window.storage.clearAll();
            setConfig(null); setCurrentRound(1); setOpenedPackets(new Set()); setWonPrizes([]); setShowResult(null); setSelectedPacketId(null); setRedPackets([]); setShowReconfigModal(false); setCurrentPage('setup');
        };

        const handleReconfigEdit = async () => {
            setShowReconfigModal(false);
            setCurrentPage('setup');
        };

        const closeResultModal = () => { setShowResult(null); setSelectedPacketId(null); };

        if (currentPage === 'loading') return <div className="min-h-screen bg-gradient-to-br from-red-500 via-pink-500 to-purple-600 flex items-center justify-center text-white text-2xl">åŠ è½½ä¸­...</div>;
        if (currentPage === 'setup') return <SetupPage onSubmit={handleSetupSubmit} initialConfig={config} />;

        // --- æ¢å¤åŸå§‹ç½‘æ ¼å¸ƒå±€é€»è¾‘ ---
        // ä½¿ç”¨åŠ¨æ€è®¡ç®—çš„åˆ—æ•°ï¼Œä½¿çº¢åŒ…ç¾¤å±…ä¸­ä¸”æ•´é½ï¼Œè§£å†³å…¨å±é“ºæ»¡å¯èƒ½å¯¼è‡´çš„æ»šåŠ¨æ¡é—®é¢˜
        const gridCols = Math.ceil(Math.sqrt(config.totalPackets * 1.2));
        const gridMaxWidth = `${gridCols * 100}px`; // 100px = çº¢åŒ…å®½90px + é—´éš™

        return (
            <div className="min-h-screen bg-gradient-to-br from-red-500 via-pink-500 to-purple-600 relative overflow-hidden flex flex-col">
                
                {/* è£…é¥°æ€§å…ƒç´  (åŸç‰ˆ) */}
                <div className="absolute inset-0 overflow-hidden pointer-events-none">
                    <div className="absolute top-10 left-10 w-32 h-32 bg-yellow-300 rounded-full opacity-20 blur-3xl"></div>
                    <div className="absolute bottom-20 right-20 w-40 h-40 bg-pink-300 rounded-full opacity-20 blur-3xl"></div>
                </div>

                {/* é¡¶éƒ¨ä¿¡æ¯æ  (åŸç‰ˆç®€æ´ UI) */}
                <div className="relative z-10 p-6">
                    <div className="max-w-7xl mx-auto flex justify-between items-center">
                        <div className="text-white">
                            <h1 className="text-3xl font-bold mb-2">ğŸ§§ çº¢åŒ…æŠ½å¥–</h1>
                            <p className="text-white/90">ç¬¬ {currentRound} / {config.totalRounds} è½®</p>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={() => setShowResetModal(true)} className="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg backdrop-blur-sm transition flex items-center gap-2 active:scale-95">
                                <RotateCcw size={18} /> é‡ç½®æœ¬è½®
                            </button>
                            <button onClick={() => setShowReconfigModal(true)} className="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg backdrop-blur-sm transition flex items-center gap-2 active:scale-95">
                                <Settings size={18} /> é‡æ–°è®¾ç½®
                            </button>
                        </div>
                    </div>
                </div>

                {/* ç»Ÿè®¡ä¿¡æ¯ */}
                <div className="relative z-10 px-6 mb-6">
                    <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div className="bg-white/10 backdrop-blur-md rounded-2xl p-6">
                            <div className="flex justify-between items-center text-white">
                                <div>
                                    <p className="text-sm opacity-80">å·²æŠ½å–</p>
                                    <p className="text-3xl font-bold">{openedCount} / {config.totalPackets}</p>
                                </div>
                                <div className="flex gap-2 text-center text-xs">
                                    {config.prizes.map((p,i)=><div key={i}><div style={{backgroundColor:p.color}} className="w-2 h-2 rounded-full mx-auto mb-1"></div>{p.name}<br/>{p.count}</div>)}
                                </div>
                            </div>
                        </div>
                        <div className="bg-white/10 backdrop-blur-md rounded-2xl p-6 text-white custom-scrollbar overflow-y-auto max-h-24">
                            <p className="text-sm opacity-80 mb-2">æœ¬è½®å·²ä¸­å¥– ({wonPrizes.length})</p>
                            <div className="flex flex-wrap gap-2">
                                {wonPrizes.map((p, i) => <span key={i} className="px-2 py-1 bg-white/20 rounded text-xs flex items-center gap-1" style={{borderLeft:`3px solid ${p.color}`}}>{p.name}</span>)}
                            </div>
                        </div>
                    </div>
                </div>

                {/* çº¢åŒ…åŒºåŸŸ (æ¢å¤å±…ä¸­ç½‘æ ¼) */}
                <div className="relative z-10 px-6 pb-20 flex-1 overflow-y-auto custom-scrollbar">
                    <div className="max-w-7xl mx-auto flex justify-center">
                        <div 
                            className="grid gap-4 p-4"
                            style={{
                                gridTemplateColumns: `repeat(${gridCols}, minmax(0, 1fr))`,
                                maxWidth: gridMaxWidth
                            }}
                        >
                            {redPackets.map(packet => {
                                const isSelected = selectedPacketId === packet.id;
                                const isOpened = openedPackets.has(packet.id);
                                const floatDelay = `${(packet.id % 5) * 0.7}s`;
                                
                                const finalStyle = isSelected && !animating ? {
                                    transform: `translate(${packet.finalX}px, ${packet.finalY}px) rotate(${packet.finalRotation}deg) scale(1.1)`,
                                    zIndex: 50
                                } : {};

                                let baseClasses = "red-packet-base transform red-packet-inner cursor-pointer";
                                let animStyle = { animationDelay: floatDelay };

                                if (isOpened) return <div key={packet.id} className="invisible w-[90px] h-[115px]"></div>;

                                if (animating) {
                                    baseClasses += " animate-shuffle";
                                    animStyle = { 
                                        animationDelay: `${(packet.id % 7) * 0.05}s`,
                                        animationDuration: `${0.8 + (packet.id % 3) * 0.1}s`
                                    };
                                } else if (isSelected) {
                                    baseClasses += " is-selected animate-pulse-fast";
                                } else {
                                    baseClasses += " animate-waterfall hover:scale-105 hover:-translate-y-2 transition-transform duration-200";
                                }

                                return (
                                    <div key={packet.id} className="flex justify-center items-center h-full perspective-wrapper">
                                        <div className={baseClasses} style={{ ...animStyle, ...finalStyle }}>
                                            <div className="red-packet-seal">
                                                <div className="prize-coin">å¥–</div>
                                            </div>
                                            <div className="red-packet-body-deco"></div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>

                {/* æŠ½å¥–æŒ‰é’® (å±…ä¸­) */}
                <div className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-40">
                    <button
                        onClick={startDraw}
                        disabled={animating || unopenedPacketsCount === 0}
                        className={`group relative bg-gradient-to-b from-yellow-300 to-yellow-500 text-red-700 w-24 h-24 rounded-full shadow-[0_10px_30px_rgba(0,0,0,0.5)] border-4 border-yellow-200 flex items-center justify-center transition-all duration-200 ${animating ? 'scale-90 opacity-80 cursor-not-allowed' : 'hover:scale-110 hover:-translate-y-1 active:scale-95'} ${unopenedPacketsCount === 0 ? 'grayscale' : ''}`}
                    >
                        {animating ? <RotateCcw className="animate-spin" size={32} /> : <div className="flex flex-col items-center leading-none"><span className="font-bold text-2xl">æŠ½</span><span className="text-xs font-bold">START</span></div>}
                        <div className="absolute inset-0 rounded-full bg-white opacity-0 group-hover:opacity-30 transition-opacity"></div>
                    </button>
                </div>

                {/* ä¸‹ä¸€è½®æŒ‰é’® (å³ä¸‹è§’) */}
                {!isLastRound && (
                    <div className="fixed bottom-8 right-8 z-40">
                        <button
                            onClick={confirmNextRound}
                            disabled={animating}
                            className={`
                                w-14 h-14 bg-black/40 hover:bg-black/60 backdrop-blur-md text-white rounded-full 
                                flex items-center justify-center shadow-lg transition transform 
                                ${animating ? 'opacity-0' : 'hover:scale-110 active:scale-95'}
                            `}
                            title="ä¸‹ä¸€è½®"
                        >
                            <Play size={24} className="ml-1"/>
                        </button>
                    </div>
                )}

                {/* å¼¹çª—ç»„ä»¶ (UI è¿˜åŸ) */}
                {showNextRoundConfirm && <ConfirmModal title="è·³è¿‡æœ¬è½®ï¼Ÿ" message={`è¿˜æœ‰ ${unopenedPacketsCount} ä¸ªçº¢åŒ…æœªå¼€ï¼Œç¡®å®šè¿›å…¥ä¸‹ä¸€è½®å—ï¼Ÿ`} onConfirm={handleNextRound} onCancel={() => setShowNextRoundConfirm(false)} confirmText="ç¡®è®¤ä¸‹ä¸€è½®" confirmColor="bg-red-600" />}
                {showResetModal && <ConfirmModal title="é‡ç½®æœ¬è½®æŠ½å¥–" message="ç¡®å®šè¦é‡ç½®å½“å‰è½®æ¬¡å—ï¼Ÿæ‰€æœ‰å·²æŠ½å–çš„çº¢åŒ…å°†è¢«é‡ç½®ï¼Œçº¢åŒ…å°†é‡æ–°éšæœºæ’åˆ—ã€‚" onConfirm={confirmReset} onCancel={() => setShowResetModal(false)} confirmText="ç¡®è®¤é‡ç½®" confirmColor="bg-gradient-to-r from-orange-500 to-red-500" />}
                {showReconfigModal && <ReconfigModal onEdit={handleReconfigEdit} onClearAndNew={confirmReconfig} onCancel={() => setShowReconfigModal(false)} />}
                
                {/* ç»“æœå¼¹çª— */}
                {showResult !== null && (
                    <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
                        <div className="bg-white rounded-3xl p-10 text-center transform scale-100 shadow-2xl max-w-md relative">
                            <button onClick={closeResultModal} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition"><X size={24} /></button>
                            {showResult ? (
                                <>
                                    <div className="w-32 h-32 mx-auto mb-6 rounded-full flex items-center justify-center border-4 border-white shadow-xl" style={{ backgroundColor: showResult.color }}>
                                        <Gift size={64} className="text-white" />
                                    </div>
                                    <h2 className="text-4xl font-bold mb-3 text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-pink-500">æ­å–œä¸­å¥–ï¼</h2>
                                    <p className="text-2xl font-semibold text-gray-800">{showResult.name}</p>
                                </>
                            ) : (
                                <>
                                    <div className="w-32 h-32 mx-auto mb-6 bg-gray-200 rounded-full flex items-center justify-center"><span className="text-6xl">ğŸ˜Š</span></div>
                                    <h2 className="text-3xl font-bold mb-3 text-gray-700">è°¢è°¢å‚ä¸</h2>
                                    <p className="text-lg text-gray-600">ç»§ç»­åŠ æ²¹ï¼</p>
                                </>
                            )}
                        </div>
                    </div>
                )}
            </div>
        );
    };

    // --- å­ç»„ä»¶ (UI è¿˜åŸ) ---
    const ConfirmModal = ({ title, message, onConfirm, onCancel, confirmText, confirmColor }) => (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
            <div className="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl transform scale-100">
                <div className="flex justify-between items-start mb-4">
                    <h3 className="text-2xl font-bold text-gray-800">{title}</h3>
                    <button onClick={onCancel} className="text-gray-400 hover:text-gray-600"><X size={24}/></button>
                </div>
                <p className="text-gray-600 mb-8 leading-relaxed">{message}</p>
                <div className="flex gap-3">
                    <button onClick={onCancel} className="flex-1 px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-semibold transition">å–æ¶ˆ</button>
                    <button onClick={onConfirm} className={`flex-1 px-6 py-3 ${confirmColor} text-white rounded-xl font-semibold hover:shadow-lg transition`}>{confirmText}</button>
                </div>
            </div>
        </div>
    );

    const ReconfigModal = ({ onEdit, onClearAndNew, onCancel }) => (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
            <div className="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl transform scale-100">
                <div className="flex justify-between items-start mb-4">
                    <h3 className="text-2xl font-bold text-gray-800">é‡æ–°è®¾ç½®</h3>
                    <button onClick={onCancel} className="text-gray-400 hover:text-gray-600"><X size={24}/></button>
                </div>
                <p className="text-gray-600 mb-6">è¯·é€‰æ‹©é‡æ–°è®¾ç½®çš„æ–¹å¼ï¼š</p>
                <div className="space-y-3 mb-6">
                    <button onClick={onEdit} className="w-full p-4 bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 rounded-xl text-left transition group"><div className="flex items-center justify-between"><div><h4 className="font-semibold text-gray-800 mb-1">ç¼–è¾‘å½“å‰é…ç½®</h4><p className="text-sm text-gray-600">ä¿ç•™å½“å‰è®¾ç½®ï¼Œè¿›å…¥ç¼–è¾‘æ¨¡å¼ä¿®æ”¹</p></div><Settings className="text-blue-500 group-hover:rotate-90 transition-transform" size={24} /></div></button>
                    <button onClick={onClearAndNew} className="w-full p-4 bg-red-50 hover:bg-red-100 border-2 border-red-200 rounded-xl text-left transition group"><div className="flex items-center justify-between"><div><h4 className="font-semibold text-gray-800 mb-1">æ¸…ç©ºå¹¶æ–°å»º</h4><p className="text-sm text-gray-600">æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼Œä»å¤´å¼€å§‹é…ç½®</p></div><RotateCcw className="text-red-500 group-hover:rotate-180 transition-transform" size={24} /></div></button>
                </div>
                <button onClick={onCancel} className="w-full px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-semibold transition">å–æ¶ˆ</button>
            </div>
        </div>
    );

    // SetupPage ä¿æŒåŸæ · (æ­¤å¤„ç®€åŒ–æ˜¾ç¤ºï¼Œç¡®ä¿å·²åŒ…å«)
    const SetupPage = ({ onSubmit, initialConfig }) => {
        const [totalPackets, setTotalPackets] = useState(initialConfig?.totalPackets || 50);
        const [totalRounds, setTotalRounds] = useState(initialConfig?.totalRounds || 3);
        const [prizes, setPrizes] = useState(initialConfig?.prizes || [{ name: 'ä¸€ç­‰å¥–', count: 1, color: '#FFD700' }]);
        const addPrize = () => setPrizes([...prizes, { name: `å¥–é¡¹${prizes.length + 1}`, count: 1, color: '#FFD700' }]);
        const removePrize = (i) => setPrizes(prizes.filter((_, idx) => idx !== i));
        const updatePrize = (i, f, v) => { const n = [...prizes]; n[i][f] = v; setPrizes(n); };
        const handleSubmit = () => onSubmit({ totalPackets: parseInt(totalPackets), totalRounds: parseInt(totalRounds), prizes: prizes.map(p => ({ ...p, count: parseInt(p.count) })) });

        return (
            <div className="min-h-screen bg-gradient-to-br from-red-500 via-pink-500 to-purple-600 flex items-center justify-center p-6">
                <div className="bg-white rounded-3xl shadow-2xl max-w-2xl w-full p-8">
                    <h1 className="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-pink-500 mb-6 text-center">ğŸ§§ çº¢åŒ…æŠ½å¥–è®¾ç½®</h1>
                    <div className="space-y-6">
                        <div className="grid grid-cols-2 gap-4">
                            <label className="block text-sm font-semibold text-gray-700">çº¢åŒ…æ€»æ•° <input type="number" value={totalPackets} onChange={e=>setTotalPackets(e.target.value)} className="w-full border-2 border-gray-200 rounded-xl p-3 mt-1"/></label>
                            <label className="block text-sm font-semibold text-gray-700">è½®æ•° <input type="number" value={totalRounds} onChange={e=>setTotalRounds(e.target.value)} className="w-full border-2 border-gray-200 rounded-xl p-3 mt-1"/></label>
                        </div>
                        <div>
                            <div className="flex justify-between mb-2"><span className="font-semibold text-gray-700">å¥–é¡¹è®¾ç½®</span><button onClick={addPrize} className="text-sm bg-pink-500 text-white px-3 py-1 rounded">æ·»åŠ </button></div>
                            <div className="max-h-60 overflow-y-auto space-y-2 pr-2 custom-scrollbar">
                                {prizes.map((p, i) => (
                                    <div key={i} className="flex gap-2 items-center bg-gray-50 p-2 rounded-lg">
                                        <input type="color" value={p.color} onChange={e=>updatePrize(i,'color',e.target.value)} className="w-8 h-8 rounded"/>
                                        <input value={p.name} onChange={e=>updatePrize(i,'name',e.target.value)} className="border p-1 rounded flex-1" placeholder="åç§°"/>
                                        <input type="number" value={p.count} onChange={e=>updatePrize(i,'count',e.target.value)} className="border p-1 rounded w-16" placeholder="æ•°é‡"/>
                                        {prizes.length>1 && <button onClick={()=>removePrize(i)} className="text-red-500"><X size={16}/></button>}
                                    </div>
                                ))}
                            </div>
                        </div>
                        <button onClick={handleSubmit} className="w-full bg-gradient-to-r from-red-500 to-pink-500 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg transition">å¼€å§‹æŠ½å¥–</button>
                    </div>
                </div>
            </div>
        );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<LuckyDrawApp />);
  </script>
</body>
</html>